<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>服务器列表</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">OpenSDK.NEL</div>
      <ul class="menu">
        <li data-view="dash">概括</li>
        <li data-view="serverlist" class="active">服务器列表</li>
        <li data-view="game">游戏</li>
      </ul>
    </aside>
    <main class="main">
      <div class="panel">
        <h3>服务器列表</h3>
        <div class="servers-toolbar"><input id="serverKeyword" type="text" placeholder="输入关键字" value="布吉岛" /><button id="btnSearchServers" class="btn btn-primary">搜索</button></div>
        <div id="serversAlert" class="alert" style="display:none"></div>
        <div class="servers-grid" id="serversGrid"></div>
      </div>
    </main>
  </div>
  <script>
    var wsOnMessageHook=null;let ws=null;function connect(){const p=location.protocol==='https:'?'wss:':'ws:';ws=new WebSocket(`${p}//${location.host}/ws`);ws.onmessage=e=>{try{const d=JSON.parse(e.data);if(d.type==='servers')renderServers(d.items||[]);if(d.type==='notlogin'){const a=document.getElementById('serversAlert');if(a){a.textContent='未登录，请先添加账号并登录';a.style.display='block'}location.href='/dash'}if(d.type==='navigate')location.href=d.url;if(wsOnMessageHook)wsOnMessageHook(d)}catch{}}}
    function sendMessage(m){if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify(m))}
    function renderServers(items){const grid=document.getElementById('serversGrid');if(!items||items.length===0){grid.innerHTML='<div style="opacity:.7">暂无服务器数据</div>';return}grid.innerHTML=items.map(it=>`<div class=\"server-card\"><div class=\"server-name\">${it.name}</div><div class=\"server-id\">ID: ${it.entityId}</div><div class=\"server-actions\"><button class=\"btn btn-primary btn-join\" data-id=\"${it.entityId}\" data-name=\"${it.name}\">加入服务器</button></div></div>`).join('');grid.querySelectorAll('.btn-join').forEach(btn=>btn.onclick=()=>openJoinModal(btn.getAttribute('data-id'),btn.getAttribute('data-name')))}
    function openJoinModal(serverId,serverName){const overlay=document.createElement('div');overlay.className='modal-overlay';const dialog=document.createElement('div');dialog.className='modal';dialog.innerHTML=`<div class=\"modal-header\">加入服务器</div><div class=\"modal-body\"><div style=\"margin-bottom:8px;\">选择账号</div><div class=\"accounts-grid\" id=\"accountsGrid\"></div><div style=\"margin:12px 0;\">选择角色</div><div class=\"roles-grid\" id=\"rolesGrid\"></div></div><div class=\"modal-actions\"><button id=\"joinCancel\" class=\"btn\">取消</button><button id=\"joinAdd\" class=\"btn\">添加角色</button><button id=\"joinStart\" class=\"btn btn-primary\">启动</button></div>`;overlay.appendChild(dialog);document.body.appendChild(overlay);overlay.style.display='flex';let selectedRoleId='';sendMessage({type:'list_accounts'});sendMessage({type:'open_server',serverId,serverName});wsOnMessageHook=d=>{if(d.type==='accounts'){const gridA=dialog.querySelector('#accountsGrid');const itemsA=d.items||[];if(itemsA.length===0){gridA.innerHTML='<div style="opacity:.7">暂无账号，请先在概括页面添加账号</div>'}else{gridA.innerHTML=itemsA.map(a=>`<div class=\"account-card\" data-id=\"${a.entityId}\"><div class=\"account-id\">${a.entityId}</div><div class=\"account-desc\">${a.channel}</div></div>`).join('');gridA.querySelectorAll('.account-card').forEach(card=>card.onclick=()=>{const id=card.getAttribute('data-id');sendMessage({type:'select_account',entityId:id});gridA.querySelectorAll('.account-card').forEach(c=>c.classList.remove('active'));card.classList.add('active');sendMessage({type:'open_server',serverId,serverName})})}}if(d.type==='server_roles'){const grid=dialog.querySelector('#rolesGrid');const items=d.items||[];if(items.length===0){grid.innerHTML='<div style="opacity:.7">暂无角色</div>'}else{grid.innerHTML=items.map(r=>`<div class=\"role-card\" data-id=\"${r.id}\"><div class=\"role-name\">${r.name}</div></div>`).join('');grid.querySelectorAll('.role-card').forEach(card=>card.onclick=()=>{selectedRoleId=card.getAttribute('data-id');grid.querySelectorAll('.role-card').forEach(c=>c.classList.remove('active'));card.classList.add('active')})}if(d.createdName){const card=Array.from(grid.querySelectorAll('.role-card')).find(c=>c.textContent===d.createdName);if(card){selectedRoleId=card.getAttribute('data-id');card.classList.add('active')}}}};const close=()=>{overlay.remove()};dialog.querySelector('#joinCancel').onclick=close;dialog.querySelector('#joinAdd').onclick=()=>openAddRoleModal(serverId);dialog.querySelector('#joinStart').onclick=()=>{const v=selectedRoleId;if(v)sendMessage({type:'start_proxy',serverId,serverName,roleId:v});close()}}
    function openAddRoleModal(serverId){const overlay=document.createElement('div');overlay.className='modal-overlay';const dialog=document.createElement('div');dialog.className='modal';dialog.innerHTML=`<div class=\"modal-header\">添加角色</div><div class=\"modal-body\"><input id=\"roleNameInput\" type=\"text\" placeholder=\"输入角色名称\" /><div style=\"margin-top:8px; display:flex; gap:8px;\"><button id=\"btnRandom\" class=\"btn\">随机名字</button><button id=\"btnManual\" class=\"btn btn-primary\">添加</button></div></div><div class=\"modal-actions\"><button id=\"addCancel\" class=\"btn\">关闭</button></div>`;overlay.appendChild(dialog);document.body.appendChild(overlay);overlay.style.display='flex';const close=()=>{overlay.remove()};dialog.querySelector('#addCancel').onclick=close;dialog.querySelector('#btnRandom').onclick=()=>{const letters='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';const digits='0123456789';const pool=letters+digits;let n='';for(let i=0;i<12;i++)n+=pool[Math.floor(Math.random()*pool.length)];dialog.querySelector('#roleNameInput').value=n};dialog.querySelector('#btnManual').onclick=()=>{const name=dialog.querySelector('#roleNameInput').value.trim();if(!name)return;sendMessage({type:'create_role_named',serverId,name});close()}}
    function bindNav(){document.querySelectorAll('.menu li').forEach(li=>li.addEventListener('click',()=>{const v=li.dataset.view;if(v==='dash')sendMessage({type:'open_dash'});if(v==='serverlist')sendMessage({type:'open_serverlist'});if(v==='game')sendMessage({type:'open_game'})}))}
    function requestServers(){const kw=document.getElementById('serverKeyword').value.trim();sendMessage({type:'list_servers',keyword:kw})}
    window.onload=function(){connect();bindNav();document.getElementById('btnSearchServers').onclick=requestServers;requestServers()}
  </script>
</body>
</html>