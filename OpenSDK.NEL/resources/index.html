<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSDK.NEL</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="brand">OpenSDK.NEL</div>
            <ul class="menu">
                <li data-view="summary" class="active">概括</li>
                <li data-view="servers">服务器列表</li>
                <li data-view="game">游戏</li>
            </ul>
        </aside>
        <main class="main">
            <section id="view-summary" class="view active">
                <div class="header">
                    <h1>概括</h1>
                </div>
                <div class="status">
                    <div class="status-item">
                        <div>连接状态</div>
                        <div class="status-value" id="wsStatus">断开</div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <h3>账号</h3>
                        <button class="btn btn-primary" id="btnAddAccount">添加账号</button>
                    </div>
                    <div class="account-list" id="accountList">
                        <div class="account-item"><div>暂无账号</div></div>
                    </div>
                </div>
            </section>
            <section id="view-servers" class="view">
                <div class="panel">
                    <h3>服务器列表</h3>
                    <div class="servers-toolbar">
                        <input id="serverKeyword" type="text" placeholder="输入关键字" value="布吉岛" />
                        <button id="btnSearchServers" class="btn btn-primary">搜索</button>
                    </div>
                    <div id="serversAlert" class="alert" style="display:none"></div>
                    <div class="servers-grid" id="serversGrid"></div>
                </div>
            </section>
            <section id="view-game" class="view">
                <div class="panel">
                    <h3>游戏</h3>
                    <div class="channels-grid" id="channelsGrid"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        var wsOnMessageHook = null;
        let ws = null;
        let clientCount = 0;
        let trafficSent = 0;
        
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateConnectionStatus(true);
                addLog('WebSocket连接已建立', 'info');
                
                sendMessage({
                    type: 'register',
                    clientType: 'web-ui',
                    timestamp: new Date().toISOString()
                });
            };
            
            ws.onmessage = function(event) {
                try { const data = JSON.parse(event.data); handleMessage(data); if (wsOnMessageHook) wsOnMessageHook(data); }
                catch (e) { addLog(`收到消息: ${event.data}`, 'info'); }
            };
            
            ws.onclose = function() {
                updateConnectionStatus(false);
                addLog('WebSocket连接已断开', 'error');
                
                setTimeout(connect, 5000);
            };
            
            ws.onerror = function(error) {
                addLog('WebSocket连接错误', 'error');
            };
        }
        
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }
        
        function handleMessage(data) {
            switch (data.type) {
                case 'client_update':
                    updateClientList(data.clients);
                    break;
                case 'accounts':
                    renderAccounts(data.items || []);
                    break;
                case 'servers':
                    renderServers(data.items || []);
                    break;
                case 'notlogin':
                    var alert = document.getElementById('serversAlert');
                    if (alert) { alert.textContent = '未登录，请先添加账号并登录'; alert.style.display = 'block'; }
                    switchView('summary');
                    break;
                case 'traffic_update':
                    updateTrafficStats(data);
                    break;
                case 'log':
                    addLog(data.message, data.level || 'info');
                    break;
                case 'ping':
                    sendMessage({ type: 'pong', timestamp: new Date().toISOString() });
                    break;
                case 'channels':
                    renderChannels(data.items || []);
                    break;
                default:
                    addLog(`未知消息类型: ${data.type}`, 'warning');
            }
        }
        
        function updateConnectionStatus(connected) {
            const wsStatus = document.getElementById('wsStatus');
            
            if (connected) {
                wsStatus.textContent = '已连接';
                wsStatus.style.color = '#4CAF50';
            } else {
                wsStatus.textContent = '断开';
                wsStatus.style.color = '#f44336';
            }
        }
        
        function renderAccounts(items) {
            const list = document.getElementById('accountList');
            if (!items || items.length === 0) {
                list.innerHTML = '<div class="account-item"><div>暂无账号</div></div>';
                return;
            }
            list.innerHTML = items.map(it => `
                <div class="account-row">
                    <div class="account-main">
                        <div class="account-id">${it.entityId}</div>
                        <div class="account-desc">${it.channel}</div>
                    </div>
                    <div class="account-actions">
                        <button class="btn btn-danger btn-delete" data-id="${it.entityId}">删除</button>
                    </div>
                </div>
            `).join('');
            list.querySelectorAll('.btn-delete').forEach(btn => btn.onclick = () => {
                const id = btn.getAttribute('data-id');
                sendMessage({ type: 'delete_account', entityId: id });
            });
        }

        function addAccount(entityId, channel) {
            const list = document.getElementById('accountList');
            if (list.querySelector('.account-item')) list.innerHTML = '';
            const item = document.createElement('div');
            item.className = 'account-row';
            item.innerHTML = `
                <div class="account-main">
                    <div class="account-id">${entityId}</div>
                    <div class="account-desc">${channel}</div>
                </div>
                <div class="account-actions">
                    <button class="btn btn-danger btn-delete">删除</button>
                </div>`;
            list.appendChild(item);
            item.querySelector('.btn-delete').onclick = () => item.remove();
        }
        
        function updateTrafficStats(data) {
            const trafficElement = document.getElementById('trafficSent');
            trafficSent = data.totalBytes || 0;
            
            let displayValue;
            if (trafficSent < 1024) {
                displayValue = trafficSent + ' B';
            } else if (trafficSent < 1024 * 1024) {
                displayValue = (trafficSent / 1024).toFixed(2) + ' KB';
            } else if (trafficSent < 1024 * 1024 * 1024) {
                displayValue = (trafficSent / (1024 * 1024)).toFixed(2) + ' MB';
            } else {
                displayValue = (trafficSent / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
            }
            
            trafficElement.textContent = displayValue;
        }
        
        function addLog(message, level = 'info') {}

        function renderServers(items) {
            const grid = document.getElementById('serversGrid');
            if (!items || items.length === 0) {
                grid.innerHTML = '<div style="opacity:.7">暂无服务器数据</div>';
                return;
            }
            grid.innerHTML = items.map(it => `
                <div class="server-card">
                    <div class="server-name">${it.name}</div>
                    <div class="server-id">ID: ${it.entityId}</div>
                    <div class="server-actions"><button class="btn btn-primary btn-join" data-id="${it.entityId}" data-name="${it.name}">加入服务器</button></div>
                </div>
            `).join('');
            grid.querySelectorAll('.btn-join').forEach(btn => btn.onclick = () => openJoinModal(btn.getAttribute('data-id'), btn.getAttribute('data-name')));
        }

        function openJoinModal(serverId, serverName) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.innerHTML = `
                <div class="modal-header">加入服务器</div>
                <div class="modal-body">
                    <div style="margin-bottom:8px;">选择账号</div>
                    <div class="accounts-grid" id="accountsGrid"></div>
                    <div style="margin:12px 0;">选择角色</div>
                    <div class="roles-grid" id="rolesGrid"></div>
                </div>
                <div class="modal-actions">
                    <button id="joinCancel" class="btn">取消</button>
                    <button id="joinAdd" class="btn">添加角色</button>
                    <button id="joinStart" class="btn btn-primary">启动</button>
                </div>
            `;
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            overlay.style.display = 'flex';
            let selectedRoleId = '';
            sendMessage({ type: 'list_accounts' });
            sendMessage({ type: 'open_server', serverId, serverName });
            wsOnMessageHook = data => {
                if (data.type === 'accounts') {
                    const gridA = dialog.querySelector('#accountsGrid');
                    const itemsA = data.items || [];
                    if (itemsA.length === 0) {
                        gridA.innerHTML = '<div style="opacity:.7">暂无账号，请先在概括页面添加账号</div>';
                    } else {
                        gridA.innerHTML = itemsA.map(a => `
                            <div class="account-card" data-id="${a.entityId}">
                                <div class="account-id">${a.entityId}</div>
                                <div class="account-desc">${a.channel}</div>
                            </div>
                        `).join('');
                        gridA.querySelectorAll('.account-card').forEach(card => card.onclick = () => {
                            const id = card.getAttribute('data-id');
                            sendMessage({ type: 'select_account', entityId: id });
                            gridA.querySelectorAll('.account-card').forEach(c => c.classList.remove('active'));
                            card.classList.add('active');
                            sendMessage({ type: 'open_server', serverId, serverName });
                        });
                    }
                }
                if (data.type === 'server_roles' && data.serverId === serverId) {
                    const grid = dialog.querySelector('#rolesGrid');
                    const items = data.items || [];
                    if (items.length === 0) {
                        grid.innerHTML = '<div style="opacity:.7">暂无角色</div>';
                    } else {
                        grid.innerHTML = items.map(r => `
                            <div class="role-card" data-id="${r.id}">
                                <div class="role-name">${r.name}</div>
                            </div>
                        `).join('');
                        grid.querySelectorAll('.role-card').forEach(card => card.onclick = () => {
                            selectedRoleId = card.getAttribute('data-id');
                            grid.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
                            card.classList.add('active');
                        });
                    }
                    if (data.createdName) {
                        const card = Array.from(grid.querySelectorAll('.role-card')).find(c => c.textContent === data.createdName);
                        if (card) {
                            selectedRoleId = card.getAttribute('data-id');
                            card.classList.add('active');
                        }
                    }
                }
            };
            const close = () => { overlay.remove(); };
            dialog.querySelector('#joinCancel').onclick = close;
            dialog.querySelector('#joinAdd').onclick = () => openAddRoleModal(serverId);
            dialog.querySelector('#joinStart').onclick = () => {
                const v = selectedRoleId;
                if (v) sendMessage({ type: 'start_proxy', serverId, serverName, roleId: v });
                close();
            };
        }

        function openAddRoleModal(serverId) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.innerHTML = `
                <div class="modal-header">添加角色</div>
                <div class="modal-body">
                    <input id="roleNameInput" type="text" placeholder="输入角色名称" />
                    <div style="margin-top:8px; display:flex; gap:8px;">
                        <button id="btnRandom" class="btn">随机名字</button>
                        <button id="btnManual" class="btn btn-primary">添加</button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="addCancel" class="btn">关闭</button>
                </div>
            `;
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            overlay.style.display = 'flex';
            const close = () => { overlay.remove(); };
            dialog.querySelector('#addCancel').onclick = close;
            dialog.querySelector('#btnRandom').onclick = () => {
                const letters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const digits = '0123456789';
                const pool = letters + digits;
                let n = '';
                for (let i = 0; i < 12; i++) n += pool[Math.floor(Math.random() * pool.length)];
                dialog.querySelector('#roleNameInput').value = n;
            };
            dialog.querySelector('#btnManual').onclick = () => {
                const name = dialog.querySelector('#roleNameInput').value.trim();
                if (!name) return;
                sendMessage({ type: 'create_role_named', serverId, name });
                close();
            };
        }
        
        function switchView(id) {
            document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelector(`.menu li[data-view="${id}"]`).classList.add('active');
            document.getElementById(`view-${id}`).classList.add('active');
            if (id === 'servers') requestServers();
            if (id === 'game') sendMessage({ type: 'list_channels' });
        }
        function requestServers() {
            var kwInput = document.getElementById('serverKeyword');
            var kw = kwInput ? kwInput.value.trim() : '';
            sendMessage({ type: 'list_servers', keyword: kw });
        }
        window.onload = function() {
            connect();
            var btnConn = document.getElementById('btnConnect');
            if (btnConn) btnConn.onclick = connect;
            const modal = createModal();
            document.getElementById('btnAddAccount').onclick = () => modal.open();
            document.querySelectorAll('.menu li').forEach(li => li.addEventListener('click', () => switchView(li.dataset.view)));
            var btnSearch = document.getElementById('btnSearchServers');
            if (btnSearch) btnSearch.onclick = requestServers;
        };

        function createModal() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.innerHTML = `
                <div class="modal-header">添加账号</div>
                <div class="modal-body">
                    <div style="display:flex;gap:8px;margin-bottom:8px;">
                        <button id="tabCookie" class="btn btn-primary">Cookie</button>
                        <button id="tab4399" class="btn">4399账号</button>
                    </div>
                    <div id="paneCookie">
                        <input id="modalCookie" type="text" placeholder="输入Cookie" />
                    </div>
                    <div id="pane4399" style="display:none;">
                        <input id="acc4399" type="text" placeholder="账号" style="margin-bottom:8px;"/>
                        <input id="pwd4399" type="password" placeholder="密码"/>
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="modalCancel" class="btn">取消</button>
                    <button id="modalOk" class="btn btn-primary">登录</button>
                </div>
            `;
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            overlay.style.display = 'none';
            const open = () => { overlay.style.display = 'flex'; };
            const close = () => { overlay.style.display = 'none'; };
            dialog.querySelector('#modalCancel').onclick = close;
            const paneCookie = dialog.querySelector('#paneCookie');
            const pane4399 = dialog.querySelector('#pane4399');
            dialog.querySelector('#tabCookie').onclick = () => { paneCookie.style.display='block'; pane4399.style.display='none'; };
            dialog.querySelector('#tab4399').onclick = () => { paneCookie.style.display='none'; pane4399.style.display='block'; };
            dialog.querySelector('#modalOk').onclick = () => {
                if (paneCookie.style.display !== 'none') {
                    const cookie = dialog.querySelector('#modalCookie').value.trim();
                    if (!cookie) return;
                    sendMessage({ type: 'cookie_login', cookie });
                    close();
                    return;
                }
                const account = dialog.querySelector('#acc4399').value.trim();
                const password = dialog.querySelector('#pwd4399').value.trim();
                if (!account || !password) return;
                sendMessage({ type: 'login_4399', account, password });
                close();
            };
            wsOnMessageHook = data => {
                if (data.type === 'login_success') addAccount(data.entityId, data.channel);
                if (data.type === 'captcha_required') openCaptchaModal(data.account, data.password, data.sessionId);
            };
            return { open };
        }

        function openCaptchaModal(account, password, sessionId) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            const dialog = document.createElement('div');
            dialog.className = 'modal';
            dialog.innerHTML = `
                <div class="modal-header">输入验证码</div>
                <div class="modal-body">
                    <input id="captchaInput" type="text" placeholder="输入图形验证码" />
                </div>
                <div class="modal-actions">
                    <button id="capCancel" class="btn">取消</button>
                    <button id="capOk" class="btn btn-primary">提交</button>
                </div>
            `;
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            overlay.style.display = 'flex';
            const close = () => { overlay.remove(); };
            dialog.querySelector('#capCancel').onclick = close;
            dialog.querySelector('#capOk').onclick = () => {
                const captcha = dialog.querySelector('#captchaInput').value.trim();
                if (!captcha) return;
                sendMessage({ type: 'login_4399_with_captcha', sessionId, captcha });
                close();
            };
        }

        
    </script>
</body>
</html>