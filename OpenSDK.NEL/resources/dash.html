<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>概括</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <div class="layout">
    <aside id="sidebar"></aside>
    <main class="main">
      <div class="status"><div class="status-item"><div>连接状态</div><div class="status-value" id="wsStatus">断开</div></div></div>
      <div class="panel">
        <div class="panel-header"><h3>账号</h3><button class="btn btn-primary" id="btnAddAccount">添加账号</button></div>
        <div class="account-list" id="accountList"><div class="account-item"><div>暂无账号</div></div></div>
      </div>
    </main>
  </div>
  <script>
    var wsOnMessageHook = null; let ws=null;
    function connect(){const protocol=location.protocol==='https:'?'wss:':'ws:';const url=`${protocol}//${location.host}/ws`;ws=new WebSocket(url);ws.onopen=()=>{update(true)};ws.onmessage=e=>{try{const d=JSON.parse(e.data);if(d.type==='accounts')renderAccounts(d.items||[]);if(d.type==='navigate')location.href=d.url;if(wsOnMessageHook)wsOnMessageHook(d)}catch{}};ws.onclose=()=>update(false)}
    function sendMessage(m){if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify(m))}
    function update(ok){const el=document.getElementById('wsStatus');if(!el)return;el.textContent=ok?'已连接':'断开';el.style.color=ok?'#4CAF50':'#f44336'}
    function renderAccounts(items){const list=document.getElementById('accountList');if(!items||items.length===0){list.innerHTML='<div class="account-item"><div>暂无账号</div></div>';return}list.innerHTML=items.map(it=>`<div class="account-row"><div class="account-main"><div class="account-id">${it.entityId}</div><div class="account-desc">${it.channel}</div></div><div class="account-actions"><button class="btn btn-danger btn-delete" data-id="${it.entityId}">删除</button></div></div>`).join('');list.querySelectorAll('.btn-delete').forEach(b=>b.onclick=()=>{const id=b.getAttribute('data-id');sendMessage({type:'delete_account',entityId:id})})}
    function createModal(){const overlay=document.createElement('div');overlay.className='modal-overlay';const dialog=document.createElement('div');dialog.className='modal';dialog.innerHTML=`<div class="modal-header">添加账号</div><div class="modal-body"><div style="display:flex;gap:8px;margin-bottom:8px;"><button id="tabCookie" class="btn btn-primary">Cookie</button><button id="tab4399" class="btn">4399账号</button><button id="tabX19" class="btn">网易账号</button></div><div id="paneCookie"><input id="modalCookie" type="text" placeholder="输入Cookie" /><div id="loginAlert" style="margin-top:8px;color:#ef4444;display:none"></div></div><div id="pane4399" style="display:none;"><input id="acc4399" type="text" placeholder="账号" style="margin-bottom:8px;"/><input id="pwd4399" type="password" placeholder="密码"/><div id="loginAlert4399" style="margin-top:8px;color:#ef4444;display:none"></div></div><div id="paneX19" style="display:none;"><input id="emailX19" type="email" placeholder="邮箱" style="margin-bottom:8px;"/><input id="pwdX19" type="password" placeholder="密码"/><div id="loginAlertX19" style="margin-top:8px;color:#ef4444;display:none"></div></div></div><div class="modal-actions"><button id="modalCancel" class="btn">取消</button><button id="modalOk" class="btn btn-primary">登录</button></div>`;overlay.appendChild(dialog);document.body.appendChild(overlay);overlay.style.display='none';const open=()=>{overlay.style.display='flex'};const close=()=>{overlay.style.display='none'};dialog.querySelector('#modalCancel').onclick=close;const paneCookie=dialog.querySelector('#paneCookie');const pane4399=dialog.querySelector('#pane4399');const paneX19=dialog.querySelector('#paneX19');dialog.querySelector('#tabCookie').onclick=()=>{paneCookie.style.display='block';pane4399.style.display='none';paneX19.style.display='none'};dialog.querySelector('#tab4399').onclick=()=>{paneCookie.style.display='none';pane4399.style.display='block';paneX19.style.display='none'};dialog.querySelector('#tabX19').onclick=()=>{paneCookie.style.display='none';pane4399.style.display='none';paneX19.style.display='block'};dialog.querySelector('#modalOk').onclick=()=>{if(paneCookie.style.display!=='none'){const cookie=dialog.querySelector('#modalCookie').value.trim();if(!cookie)return;sendMessage({type:'cookie_login',cookie});return}if(pane4399.style.display!=='none'){const account=dialog.querySelector('#acc4399').value.trim();const password=dialog.querySelector('#pwd4399').value.trim();if(!account||!password)return;sendMessage({type:'login_4399',account,password});return}const email=dialog.querySelector('#emailX19').value.trim();const pwd=dialog.querySelector('#pwdX19').value.trim();if(!email||!pwd)return;sendMessage({type:'login_x19',email,password:pwd})};wsOnMessageHook=d=>{if(d.type==='Success_login'){addAccount(d.entityId,d.channel);close()}if(d.type==='login_error'){let el=null;if(paneCookie.style.display!=='none')el=dialog.querySelector('#loginAlert');else if(pane4399.style.display!=='none')el=dialog.querySelector('#loginAlert4399');else el=dialog.querySelector('#loginAlertX19');if(el){el.textContent=d.message||'登录失败';el.style.display='block'}}if(d.type==='captcha_required'){const account=dialog.querySelector('#acc4399').value.trim();const password=dialog.querySelector('#pwd4399').value.trim();openCaptchaModal(account,password)}};return{open}}
    function addAccount(id,ch){const list=document.getElementById('accountList');if(list.querySelector('.account-item'))list.innerHTML='';const item=document.createElement('div');item.className='account-row';item.innerHTML=`<div class="account-main"><div class="account-id">${id}</div><div class="account-desc">${ch}</div></div><div class="account-actions"><button class="btn btn-danger btn-delete">删除</button></div>`;list.appendChild(item);item.querySelector('.btn-delete').onclick=()=>item.remove()}
    function openCaptchaModal(account,password){const overlay=document.createElement('div');overlay.className='modal-overlay';const dialog=document.createElement('div');dialog.className='modal';dialog.innerHTML=`<div class="modal-header">输入验证码</div><div class="modal-body"><input id="sessionInput" type="text" placeholder="输入会话ID" style="margin-bottom:8px;" /><input id="captchaInput" type="text" placeholder="输入图形验证码" /><div id="capAlert" style="margin-top:8px;color:#ef4444;display:none"></div></div><div class="modal-actions"><button id="capCancel" class="btn">取消</button><button id="capOk" class="btn btn-primary">提交</button></div>`;overlay.appendChild(dialog);document.body.appendChild(overlay);overlay.style.display='flex';const close=()=>{overlay.remove()};dialog.querySelector('#capCancel').onclick=close;dialog.querySelector('#capOk').onclick=()=>{const sessionId=dialog.querySelector('#sessionInput').value.trim();const captcha=dialog.querySelector('#captchaInput').value.trim();if(!sessionId||!captcha)return;sendMessage({type:'login_4399_with_captcha',account,password,sessionId,captcha})};const prev=wsOnMessageHook;wsOnMessageHook=d=>{if(d.type==='Success_login'){close();if(prev)prev(d)}if(d.type==='login_error'){const el=dialog.querySelector('#capAlert');if(el){el.textContent=d.message||'登录失败';el.style.display='block'}}}}
    function bindNav(){document.querySelectorAll('.menu li').forEach(li=>li.addEventListener('click',()=>{const v=li.dataset.view;if(v==='dash')sendMessage({type:'open_dash'});if(v==='serverlist')sendMessage({type:'open_serverlist'});if(v==='game')sendMessage({type:'open_game'})}))}
    async function loadSidebar(){const res=await fetch('/sidebar.html');const html=await res.text();document.getElementById('sidebar').innerHTML=html;bindNav();document.querySelector('.menu li[data-view="dash"]').classList.add('active')}
    window.onload=function(){connect();loadSidebar();sendMessage({type:'list_accounts'});const modal=createModal();document.getElementById('btnAddAccount').onclick=()=>modal.open()}
  </script>
</body>
</html>